<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='rh.css') }}">
    <title>RH</title>
</head>
<body>
    <div class="rh-page">
        <body class="rh-page">
            <div class="upper-bar">
                <button onclick="setupForm()">Gerenciar <br> RH</button>
                <div class="welcome-section">
                    <h1>Bem-vindo <span id="user"></span> ao RH</h1>
                    <button id="logoutButton">Sair</button>
                </div>
                <button onclick="showProducts()">Ver Todos <br> os Funcionários</button>
            </div>
            <div id="formContainer" style="display:none;">
                <form id="employeeForm" method="POST" action="{{ url_for('rh_management.manage_employee') }}" onsubmit="handleSubmit(event)">
                    <div class="container-register">
                        <h1>Registrar Funcionário</h1>
                            <label for="login">Nome de Usuário:</label>
                            <input type="text" id="login" name="login" required minlength="5" pattern="[a-z0-9]+" placeholder="Digite seu nome de usuário">
                            <label for="password">Senha:</label>
                            <input type="password" id="password" name="password" required minlength="8" placeholder="Digite sua senha">
                            <label for="confirmPassword">Confirme sua senha:</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required minlength="8" placeholder="Confirme sua senha">
                            <label for="id">ID de Acesso:</label>
                            <p id="id"></p>
                            <button onclick="generateId()">Gerar ID</button>

                            <div id="personalData">

                                <h3>Dados Pessoais</h3>
                                <label for="myfile">Selecione um arquivo:</label>
                                <input type="file" id="myfile" name="myfile"><br><br>
                                <label for="name">Nome Completo do Funcionário:</label>
                                <input type="text" id="name" name="name" required placeholder="Digite seu nome completo">
                                
                                <label for="phone">Telefone:</label><br><br>
                                <input type="tel" id="phone" name="phone" placeholder="(99) 99 9 9999-9999" required><br><br>
                                <small>Format: (99) 99 9 9999-9999</small><br><br>
                                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                                <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

                                <label for="email">Email:</label>
                                <input type="email" id="email" name="email" required placeholder="Digite seu email">
                                <label for="cpf">CPF:</label>
                                <input type="text" id="cpf" name="cpf" required placeholder="Digite seu CPF">
                                <label for="birthday">Data de Nascimento:</label>
                                <div class="select-container-data" required>
                                    <select name="birthdayDay" required>
                                        <option value="">Dia</option>
                                        {% for day in range(1, 32) %}
                                            <option value="{{ day }}">{{ day }}</option>
                                        {% endfor %}
                                    </select>
                                    <select name="birthdayMonth" required>
                                        <option value="">Mês</option>
                                        {% set months = {
                                            1: "Janeiro",
                                            2: "Fevereiro", 
                                            3: "Março", 
                                            4: "Abril", 
                                            5: "Maio", 
                                            6: "Junho",
                                            7: "Julho", 
                                            8: "Agosto", 
                                            9: "Setembro", 
                                            10: "Outubro", 
                                            11: "Novembro", 
                                            12: "Dezembro" } %}
                                        {% for month in range(1, 13) %}
                                            <option value="{{ " %02d"|format(month) }}">{{ months[month] }}</option>
                                        {% endfor %}
                                    </select>
                                    <select name="birthdayYear" required>
                                        <option value="">Ano</option>
                                        {% for year in range(2024, 2040) %}
                                            <option value="{{ year }}">{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                    <label for="academicFormation">Formação Acadêmica:</label>
                                    <select name="academicFormation" required>
                                        <option value="">Formação Acadêmica</option>
                                        <option value="Ensino Médio">Ensino Médio</option>
                                        <option value="Ensino Superior">Ensino Superior</option>
                                        <option value="Pós-Graduação">Pós-Graduação</option>
                                        <option value="Mestrado">Mestrado</option>
                                        <option value="Doutorado">Doutorado</option>
                                    </select>
                                </div>
                                <div id="additionalFields" style="display:none;">
                                    <label for="salary">Salário:</label>
                                    <input type="number" id="salary" name="salary" required step="0.01" min="0">
                                    <label for="department">Departamento:</label>
                                    <div class="select-container">
                                        <select name="type" required>
                                            <option value="">Tipo</option>
                                            <option value="rh">Gerente</option>
                                            <option value="market">Vendedor</option>
                                            <option value="storage">Atendente</option>
                                        </select>
                                    </div>
                                    <label for="position">Cargo:</label>
                                    <input type="text" id="position" name="position" required placeholder="Digite o cargo">
                                    <div class="benefits">
                                        <div id="benefitsTitle"></div>
                                        <h2>Benefícios:</h2>
                                        <label for="benefits1">Vale Refeição</label>
                                        <input type="checkbox" id="benefits1" name="benefits1" value="Vale Refeição">
                                        <label for="benefits2">Vale Transporte</label>
                                        <input type="checkbox" id="benefits2" name="benefits2" value="Vale Transporte">
                                        <label for="benefits3">Plano de Saúde</label>
                                        <input type="checkbox" id="benefits3" name="benefits3" value="Plano de Saúde">
                                        <label for="benefits4">Plano Odontológico</label>
                                        <input type="checkbox" id="benefits4" name="benefits4" value="Plano Odontológico">
                                        <label for="benefits5">Seguro de Vida</label>
                                        <input type="checkbox" id="benefits5" name="benefits5" value="Seguro de Vida">
                                        <label for="benefits6">Auxílio Creche</label>
                                        <input type="checkbox" id="benefits6" name="benefits6" value="Auxílio Creche">
                                        <label for="benefits7">Auxílio Alimentação</label>
                                        <input type="checkbox" id="benefits7" name="benefits7" value="Auxílio Alimentação">
                                        <label for="benefits8">Gympass</label>
                                        <input type="checkbox" id="benefits8" name="benefits8" value="Gympass">
                                        <label for="benefits9">Participação nos Lucros</label>
                                        <input type="checkbox" id="benefits9" name="benefits9" value="Participação nos Lucros">
                                        <label for="benefits10">14º Salário</label>
                                        <input type="checkbox" id="benefits10" name="benefits10" value="14º Salário">
                                    </div>
                                    <label for="admissionDate">Data de Admissão:</label>
                                    <div class="select-container-data" required>
                                        <select name="admissionDay" required>
                                            <option value="">Dia</option>
                                            {% for day in range(1, 32) %}
                                                <option value="{{ day }}">{{ day }}</option>
                                            {% endfor %}
                                        </select>
                                        <select name="admissionMonth" required>
                                            <option value="">Mês</option>
                                            {% set months = {
                                                1: "Janeiro",
                                                2: "Fevereiro", 
                                                3: "Março", 
                                                4: "Abril", 
                                                5: "Maio", 
                                                6: "Junho",
                                                7: "Julho", 
                                                8: "Agosto", 
                                                9: "Setembro", 
                                                10: "Outubro", 
                                                11: "Novembro", 
                                                12: "Dezembro" } %}
                                            {% for month in range(1, 13) %}
                                                <option value="{{ " %02d"|format(month) }}">{{ months[month] }}</option>
                                            {% endfor %}
                                        </select>
                                        <select name="admissionYear" required>
                                            <option value="">Ano</option>
                                            {% for year in range(2024, 2040) %}
                                                <option value="{{ year }}">{{ year }}</option>
                                            {% endfor %}
                                        </select>
                                        <label for="employeeStatus">Status:</label>
                                        <select name="status" required>
                                            <option value="">Status</option>
                                            <option value="active">Ativo</option>
                                            <option value="on_vacation">Em férias</option>
                                            <option value="sick">Doente</option>
                                            <option value="inactive">Inativo</option>
                                        </select>
                                        <div class="status">
                                            <select name="inactiveStatus">
                                                <option value="">Motivo da Inativação</option>
                                                <option value="resignation">Demissão</option>
                                                <option value="fired">Desligamento</option>
                                            </select>
                                            <select name="dateOfDismissal">
                                                <select name="dateOfDismissalDay" required>
                                                    <option value="">Dia</option>
                                                    {% for day in range(1, 32) %}
                                                        <option value="{{ day }}">{{ day }}</option>
                                                    {% endfor %}
                                                </select>
                                                <select name="dateOfDismissalMonth" required>
                                                    <option value="">Mês</option>
                                                    {% set months = {
                                                        1: "Janeiro",
                                                        2: "Fevereiro", 
                                                        3: "Março", 
                                                        4: "Abril", 
                                                        5: "Maio", 
                                                        6: "Junho",
                                                        7: "Julho", 
                                                        8: "Agosto", 
                                                        9: "Setembro", 
                                                        10: "Outubro", 
                                                        11: "Novembro", 
                                                        12: "Dezembro" } %}
                                                    {% for month in range(1, 13) %}
                                                        <option value="{{ " %02d"|format(month) }}">{{ months[month] }}</option>
                                                    {% endfor %}
                                                </select>
                                                <select name="dateOfDismissalYear" required>
                                                    <option value="">Ano</option>
                                                    {% for year in range(2024, 2040) %}
                                                        <option value="{{ year }}">{{ year }}</option>
                                                    {% endfor %}
                                                </select>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div id="buttonsContainer" style="display:none;">
                                    <input type="button" value="Salvar" onclick="insertEmployee()">
                                </div>
                            </form>
                        </div>
                        <div id="employeeListContainer" style="display: none;"></div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const user = localStorage.getItem('user');
                                document.getElementById('user').textContent = user ? user : '';
                                document.getElementById('logoutButton').addEventListener('click', function() {
                                    localStorage.removeItem('user');
                                    window.location.href = '{{ url_for('home') }}';
                                });
                            });
                            
                            function generateId() {
                                let result = '';
                                document.getElementById('id').textContent = generateRandomNumbers(9);
                            }
                            function generateRandomNumbers(length) {
                                let result ='';
                                for(let i = 0; i < length; i++) {
                                    result += Math.floor(Math.random() * 10).toString();
                                }
                                return result;
                            }

                            $(document).ready(function(){
                                $('#phone').mask('(99) 99 9999-9999');
                            });

                            function setupForm() {
                                $('#formContainer').show();
                                $('#employeeListContainer').hide();
                                $('#employeeForm')[0].reset();
                                $('#additionalFields').hide();
                                $('#buttonsContainer').hide();
                            }

                            function showMessage(message) {
                                alert(message);
                            }

                            function checkCpf(cpf) {
                                var Soma;
                                var Resto;
                                Soma = 0;
                                if (cpf == "00000000000") return false;

                                for (i = 1; i < 9; i++) Soma = Soma + parseInt(cpf.substrin(i - 1, i)) * (11 - i);
                                resto = (Soma * 10) % 11;
                                if ((Resto == 10) || (Resto == 11)) Resto = 0;
                                if (Resto != parseInt(cpf.subtring(9, 10))) return false;
                                Soma = 0;
                                for (i = 0; i < 10; i++) Soma = Soma + parseInt(cpf.substring(i - 1, i)) * (12 - i);
                                Resto = (Soma * 10) % 11;
                                if ((Resto == 10) || (Resto == 11)) Resto = 0;
                                if (Resto != parseInt(cpf.substring(10, 11))) return false;
                                return true;
                            }
                            alert(checkCpf("cpf"));

                            function showEmployees() {
                                loadEmployees();
                                $('#formContainer').hide();
                                $('#employeeListContainer').show();
                            }

                            function loadEmployees() {
                                $.ajax({
                                    url: '{{ url_for('rh_management.manage_employee') }}?action=list_employees',
                                    type: 'GET',
                                    success: function (data) {
                                        if (data.success) {
                                            let employeeList = $('#employeeListContainer');
                                            employeeList.empty();
                                            employeeList.append(
                                                '<table>' +
                                                '<thead>' +
                                                    '<tr>' +
                                                        '<th>Foto</th>' +
                                                        '<th>Nome</th>' +
                                                        '<th>ID</th>' +
                                                        '<th>Departamento</th>' +
                                                        '<th>Cargo</th>' +
                                                        '<th>Status</th>' +
                                                    '</tr>' +
                                                '</thead>' +
                                                '<tbody>' +
                                                '</tbody>' +
                                                '</table>'
                                            );
                                            let tbody = employeeList.find('tbody');
                                            data.employees.forEach(employee => {
                                                tbody.append(`
                                                    <tr>
                                                        <td><img src="${employee.photo}" alt="Foto do Funcionário"></td>
                                                        <td>${employee.name}</td>
                                                        <td>${employee.id}</td>
                                                        <td>${employee.department}</td>
                                                        <td>${employee.position}</td>
                                                        <td>${employee.status}</td>
                                                        <td>
                                                            <input type="button" value="Editar" class="editButton" data-id="${employee.id}">
                                                        </td>
                                                    </tr>
                                                `);
                                            });
                                            $('.editButton').on('click', function() {
                                                let id = $(this).data('id');
                                                setupForm(id);
                                            });
                                            $('#formContainer').hide();
                                            $('#employeeListContainer').show();
                                        } else {
                                            showMessage('Erro ao carregar funcionários: ' + data.message);
                                        }
                                    },
                                    error: function () {
                                        alert('Erro ao carregar funcionários');
                                    }
                                });
                            }
                            function addEmployee() {
                                const form = $('#employeeForm');
                                const formData = new FormData(form[0]);
                                $.ajax({
                                    url: '{{ url_for('rh_management.manage_employee') }}?action=add_employee',
                                    type: 'POST',
                                    data: formData,
                                    processData: false,
                                    contentType: false,
                                    success: function (data) {
                                        showMessage(data.message);
                                        form[0].reset();
                                        $('#additionalFields').hide();
                                        setTimeout(function() {
                                            location.reload();
                                        }, 1000);
                                    },
                                    error: function () {
                                        showMessage(data.message);
                                    }
                                });
                            }
                            function checkId(id) {
                                if (id) {
                                    ids = id;
                                } else {
                                    ids = $('#id').val();
                                }
                                $.ajax({
                                    url: '{{ url_for('rh_management.manage_employee') }}?action=check_id',
                                    type: 'GET',
                                    data: { id: id }, // , id: id
                                    success: function (data) {
                                        if (data.exists) {
                                            $('#id').val(data.id);
                                            $('#id').attr('readonly', true);
                                            $('#login').val(data.login);
                                            $('#login').attr('readonly', true);
                                            $('#password').val(data.password);
                                            $('#myfile').val(data.photo);
                                            $('#name').val(data.name);
                                            $('#phone').val(data.phone);
                                            $('#email').val(data.email);
                                            $('#cpf').val(data.cpf);
                                            $('#birthdayDay').val(data.day);
                                            const monthMap = {
                                                "01": "Janeiro",
                                                "02": "Fevereiro",
                                                "03": "Março",
                                                "04": "Abril",
                                                "05": "Maio",
                                                "06": "Junho",
                                                "07": "Julho",
                                                "08": "Agosto",
                                                "09": "Setembro",
                                                "10": "Outubro",
                                                "11": "Novembro",
                                                "12": "Dezembro"
                                            };
                                            const monthName = monthMap[data.month];
                                            $('select[name="birthdayMonth"] option').each(function() {
                                                if ($(this).text() === monthName) {
                                                    $(this).prop('selected', true);
                                                }
                                            });
                                            $('select[name="birthdayYear"]').val(data.year);
                                            $('#academicFormation').val(data.academicFormation);
                                            $('#salary').val(data.salary);
                                            $('#department').val(data.department);
                                            $('#position').val(data.position);

                                            $('#benefits1').prop('checked', data.benefits1);
                                            $('#benefits2').prop('checked', data.benefits2);
                                            $('#benefits3').prop('checked', data.benefits3);
                                            $('#benefits4').prop('checked', data.benefits4);
                                            $('#benefits5').prop('checked', data.benefits5);
                                            $('#benefits6').prop('checked', data.benefits6);
                                            $('#benefits7').prop('checked', data.benefits7);
                                            $('#benefits8').prop('checked', data.benefits8);
                                            $('#benefits9').prop('checked', data.benefits9);
                                            $('#benefits10').prop('checked', data.benefits10);
                                            $('#admissionDay').val(data.day);
                                            $('#admissionMonth').val(data.month).each(function() {
                                                if ($(this).text() === monthName) {
                                                    $(this).prop('selected', true);
                                                };
                                            });
                                            $('#admissionYear').val(data.year);
                                            $('#status').val(data.status);
                                            $('#inactiveStatus').val(data.inactiveStatus);
                                            $('#dateOfDismissalDay').val(data.dateOfDismissalDay);
                                            $('#dateOfDismissalMonth').val(data.dateOfDismissalMonth).each(function() {
                                                if ($(this).text() === monthName) {
                                                    $(this).prop('selected', true);
                                                };
                                            });
                                            $('#dateOfDismissalYear').val(data.dateOfDismissalYear);
                                            $('#additionalFields').show();
                                            $('#buttonsContainer').show();
                                        } else {
                                            $('#additionalFields').hide();
                                            $('#buttonsContainer').hide();
                                        }
                                    },
                                    error: function () {
                                        showMessage('Erro ao carregar funcionário');
                                    }
                                });
                            }
                        </script>
                    </div>
                </form>
            </div>
        </body>
    </div>
</body>
</html>
